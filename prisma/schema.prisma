// Multi-Tenancy Schema - Polyx
// Architecture: User <-> UserAccessGrant <-> Organisation
// Dynamic Roles & Permissions System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE MODELS
// ============================================

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  emailVerified  DateTime?
  name           String?
  firstName      String?
  lastName       String?
  image          String?
  isGlobalAdmin  Boolean   @default(false)
  hashedPassword String?
  phone          String?
  isActive       Boolean   @default(true)

  // Relations
  accessGrants   UserAccessGrant[]
  agencies       UserAgency[]
  franchises     UserFranchise[]
  accounts       Account[]
  sessions       Session[]
  leadActivities LeadActivity[]
  calls          Call[]
  calendarEvents CalendarEvent[]
  formateur      Formateur? // Trainer profile if applicable

  // B2B Portal
  clientCompanyId String?
  clientCompany   ClientCompany? @relation(fields: [clientCompanyId], references: [id])

  // Gamification
  gamificationScore Int @default(0)
  gamificationLevel Int @default(1)
  achievements      UserAchievement[]
  challenges        ChallengeParticipant[]

  // Dashboard Personalization
  dashboardConfigs  DashboardConfig[]

  googleRefreshToken String? // For Calendar Sync
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Organisation {
  id       String  @id @default(cuid())
  name     String
  siret    String? @unique
  logo     String?
  nda      String? // Numéro de Déclaration d'Activité
  qualiopi Boolean @default(false)
  isActive Boolean @default(true)

  // Lifecycle & Validation
  status        String    @default("PENDING") // PENDING, ACTIVE, SUSPENDED, REJECTED
  activatedAt   DateTime?
  activatedById String?   // Super Admin who validated
  rejectionNote String?   // Reason if rejected

  // Primary Admin Contact (for initial invitation)
  primaryContactEmail String?
  primaryContactName  String?

  // Address
  street  String?
  zipCode String?
  city    String?
  country String? @default("France")

  // Contact
  phone   String?
  email   String?
  website String?

  // Business Data
  turnover Float?

  // Relations
  accessGrants UserAccessGrant[]
  roles        Role[]
  invitations  Invitation[]
  leads        Lead[]
  trainings    Training[]
  exams        Exam[]
  agencies     Agency[]
  franchises   Franchise[]

  integrationConfig IntegrationConfig?
  agencyMappings    AgencyMapping[]
  learners          Learner[]
  sessions          TrainingSession[]
  examSessions      ExamSession[]

  // Veille & Écosystème
  watchArticles      WatchArticle[]
  ecosystemPartners  EcosystemPartner[]

  // Finances
  invoices           Invoice[]

  // B2B Clients
  clientCompanies    ClientCompany[]

  // Strategic Reports
  strategicReports    StrategicReport[]

  // Intelligent Agenda
  calendarEvents      CalendarEvent[]

  // Formateur Management
  formateurs          Formateur[]
  formateurInvoices   FormateurInvoice[]

  // Wallet & Credits
  wallet              Wallet?

  // Organisation Groups (Multi-OF Networks)
  groupMemberships    OrganisationGroupMember[]

  // Nurturing & Automation
  nurturingSequences NurturingSequence[]
  leadSegments       LeadSegment[]
  
  // Gamification
  challenges         Challenge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("organisations")
}

model LeadSegment {
  id             String @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  name           String
  description    String?
  filterGroup    Json // Stores FilterGroup { conjunction, rules }
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organisationId])
  @@map("lead_segments")
}

// ============================================
// ORGANISATION GROUPS (Multi-OF Networks)
// ============================================

model OrganisationGroup {
  id          String @id @default(cuid())
  name        String // Ex: "Groupe FormaPro", "Réseau Excellence"
  description String?
  logo        String?
  isActive    Boolean @default(true)

  // Owner/Creator
  createdById String?

  // Members
  members     OrganisationGroupMember[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("organisation_groups")
}

model OrganisationGroupMember {
  id             String @id @default(cuid())
  groupId        String
  organisationId String
  role           String @default("MEMBER") // OWNER, ADMIN, MEMBER

  group          OrganisationGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  organisation   Organisation      @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  joinedAt       DateTime @default(now())

  @@unique([groupId, organisationId])
  @@map("organisation_group_members")
}

// ============================================
// FORMATEUR (TRAINER) MANAGEMENT
// ============================================

model Formateur {
  id             String @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  // Link to User for login access (optional)
  userId         String? @unique
  user           User? @relation(fields: [userId], references: [id])
  
  // Identity
  firstName      String
  lastName       String
  email          String
  phone          String?
  
  // Business Info
  nda            String? // Numéro de Déclaration d'Activité
  hourlyRate     Float @default(30)
  siret          String?
  iban           String?
  
  // Address
  street         String?
  zipCode        String?
  city           String?
  
  // Status
  isActive       Boolean @default(true)
  isValidated    Boolean @default(false)
  
  // Relations
  documents      FormateurDocument[]
  invoices       FormateurInvoice[]
  sessions       TrainingSession[]
  folders        LearnerFolder[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organisationId])
  @@map("formateurs")
}

model FormateurDocument {
  id           String @id @default(cuid())
  formateurId  String
  formateur    Formateur @relation(fields: [formateurId], references: [id], onDelete: Cascade)
  
  type         String // CV, DIPLOME, KBIS, VIGILANCE, NDA, CONTRAT
  fileName     String
  fileUrl      String
  
  status       String @default("PENDING") // PENDING, VALIDATED, REJECTED
  rejectionReason String?
  
  validatedAt  DateTime?
  expiresAt    DateTime? // For documents with expiration (e.g., Vigilance)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([formateurId])
  @@map("formateur_documents")
}

model FormateurInvoice {
  id             String @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id])
  
  formateurId    String
  formateur      Formateur @relation(fields: [formateurId], references: [id])
  
  // Invoice Details
  number         String
  date           DateTime @default(now())
  dueDate        DateTime
  
  // Financials
  hoursWorked    Float
  hourlyRate     Float
  totalAmount    Float
  
  status         String @default("PENDING") // PENDING, VALIDATED, PAID
  paidAt         DateTime?
  
  // Meta
  fileUrl        String? // Attached invoice PDF from formateur
  notes          String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organisationId, number])
  @@index([formateurId])
  @@map("formateur_invoices")
}

model CalendarEvent {
  id             String @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  agencyId       String?
  agency         Agency? @relation(fields: [agencyId], references: [id])
  
  leadId         String?
  lead           Lead? @relation(fields: [leadId], references: [id])
  
  userId         String // Assignee/Collaborator
  user           User @relation(fields: [userId], references: [id])

  title          String
  description    String?
  
  start          DateTime
  end            DateTime
  
  type           String @default("MEETING") // MEETING, CALL, INTERNAL, SESSION
  status         String @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED, NO_SHOW
  
  googleEventId  String? // Sync with Google Calendar
  metadata       Json? // For extra smart data

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organisationId])
  @@index([userId])
  @@index([start, end])
  @@map("calendar_events")
}

// ============================================
// PERMISSIONS & ROLES SYSTEM
// ============================================

model SystemPermission {
  id          String @id // ex: "FINANCE_VIEW", "USER_EDIT"
  description String

  // Relations
  roles Role[] @relation("RoleToPermission")

  @@map("system_permissions")
}

model Role {
  id              String  @id @default(uuid())
  name            String // ex: "Admin", "Manager", "Commercial"
  organisationId  String
  isSystemDefault Boolean @default(false)

  // Relations
  organisation Organisation       @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  permissions  SystemPermission[] @relation("RoleToPermission")
  accessGrants UserAccessGrant[]
  invitations  Invitation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("roles")
}

// ============================================
// PIVOT TABLE: MULTI-TENANCY MATRIX
// ============================================

model UserAccessGrant {
  id String @id @default(cuid())

  // Foreign Keys
  userId         String
  organisationId String
  roleId         String

  // Extra flags
  isActive Boolean @default(true)

  // Backward compatibility / convenience
  permissionsOverride String?

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: one access record per user per org
  @@unique([userId, organisationId])
  @@map("user_access_grants")
}

// ============================================
// WORKFLOW: INVITATIONS
// ============================================

model Invitation {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  status    String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED

  // Target assignment
  organisationId String
  roleId         String

  // Relations
  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invitations")
}

// ============================================
// AUTH (NextAuth compatible)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// BUSINESS ENTITIES
// ============================================

// ============================================
// ACADEMY MODULE (Training Catalog)
// ============================================

// ============================================
// LEARNERS MODULE (Post-Sales / Pedagogy)
// ============================================

model Learner {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  // Identity (SNAPSHOT from Lead/User)
  firstName String
  lastName  String
  email     String
  phone     String?
  
  gender         String? // M, F
  birthDate      DateTime?
  nationality    String?
  nativeLanguage String?

  // Link to other modules
  userId String? // If they have access to the platform (User.id)
  leadId String? @unique // Origin lead (Lead.id)
  lead   Lead?   @relation(fields: [leadId], references: [id])

  // Address (from CPF API)
  address    String?
  postalCode String?
  city       String?

  // Agency Assignment
  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  // Relations
  clientCompanyId String?
  clientCompany   ClientCompany? @relation(fields: [clientCompanyId], references: [id])

  folders           LearnerFolder[]
  examRegistrations ExamRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("learners")
}

model LearnerFolder {
  id        String  @id @default(cuid())
  learnerId String
  learner   Learner @relation(fields: [learnerId], references: [id], onDelete: Cascade)

  trainingId String?
  training   Training? @relation(fields: [trainingId], references: [id])

  // Funding & Compliance
  fundingType      String @default("PERSO") // CPF, PERSO, OPCO, POLE_EMPLOI
  status           String @default("ONBOARDING") // ONBOARDING, IN_TRAINING, COMPLETED, DROPPED
  complianceStatus String @default("PENDING") // PENDING, VALID, ALERT, REJECTED

  // External CPF/EDOF Data (Synced via API)
  externalFileId String? // Numéro de dossier (ex: 4014...)
  funderName     String? // ex: "CAISSE DE DÉPOT"
  cpfStatus      String? // Statut CPF legacy (for badge display)

  // CDC Progress Status (A_TRAITER, EN_ATTENTE, ACCEPTE, ENTREE_DECLAREE, SORTIE_DECLAREE, SERVICE_FAIT_DECLARE, SERVICE_FAIT_VALIDE, FACTURE)
  cpfProgressStatus String? @default("A_TRAITER")

  // Milestone Dates (via API sync)
  receivedDate         DateTime? // A traiter - date de réception
  acceptanceDate       DateTime? // Accepté - par le titulaire
  entryDeclaredDate    DateTime? // Entrée déclarée
  exitDeclaredDate     DateTime? // Sortie déclarée
  serviceDeclaredDate  DateTime? // Service fait déclaré
  serviceValidatedDate DateTime? // Service fait validé par CDC
  invoicedDate         DateTime? // Facturé

  // Financials
  trainingAmount Float? // Montant Prise en Charge (€)

  // Pedagogy Details (Snapshot from API)
  trainingTitle      String? // Titre complet de la formation
  trainingLocation   String? // Lieu ex: PANTIN
  trainingPostalCode String? // CP lieu formation ex: 93500
  trainingDuration   Int? // Durée totale (h)
  hoursUsed          Int     @default(0) // Heures consommées
  remainingHours     Int? // Durée restante (h)
  weeklyIntensity    String? // ex: "10h"

  // Formateur Assignment
  formateurId    String? // Link to Formateur
  formateur      Formateur? @relation(fields: [formateurId], references: [id])
  formateurNda   String? // NDA du formateur
  formateurCvUrl String? // CV du formateur

  // Advanced Status Flags (New UI)
  examDate      DateTime?
  isBlocked     Boolean   @default(false)
  blockReason   String?
  isLowLevel    Boolean   @default(false)
  isDropoutRisk Boolean   @default(false)

  // Timeline
  officialStartDate DateTime?
  officialEndDate   DateTime?
  actualStartDate   DateTime?
  actualEndDate     DateTime?

  // Relations
  documents      LearnerDocument[]
  attendanceLogs AttendanceLog[]
  surveys        SatisfactionSurvey[]
  complaints     Complaint[]
  invoices       Invoice[]

  // LMS Integration
  lmsEnrollmentId  String?   // Enrollment ID from LMS
  lmsEnrolledAt    DateTime? // When enrolled in LMS
  lmsGrade         Float?    // Grade from LMS (0-100)
  lmsCompletion    Float?    // Completion % from LMS
  lmsLastSyncAt    DateTime? // Last sync time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("learner_folders")
}

model SatisfactionSurvey {
  id        String   @id @default(cuid())
  folderId  String
  folder    LearnerFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)

  type           String   @default("HOT") // HOT (à chaud), COLD (à froid)
  rating         Int      // Overall rating 1-5
  contentQuality Int?     // 1-5
  pacingQuality  Int?     // 1-5
  supportQuality Int?     // 1-5
  comment        String?
  
  // AI Analysis (Gemini)
  sentiment    String?   // POSITIVE, NEUTRAL, NEGATIVE
  tags         String?   // Comma separated tags (Pédagogie, Admin, etc.)
  summary      String?
  
  answeredAt     DateTime @default(now())

  @@unique([folderId, type])
  @@map("satisfaction_surveys")
}

model Complaint {
  id        String   @id @default(cuid())
  folderId  String
  folder    LearnerFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)

  type      String   // PEDAGOGIQUE, TECHNIQUE, ADMINISTRATIF, AUTRE
  subject   String
  content   String
  
  status    String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority  String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  
  resolution String? // Action corrective apportée
  resolvedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("complaints")
}

model LearnerDocument {
  id       String        @id @default(cuid())
  folderId String
  folder   LearnerFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)

  type  String // CONVENTION, EMARGEMENT, ATTESTATION_ENTREE, etc.
  label String? // Human readable label

  status String @default("MISSING") // MISSING, PENDING_REVIEW, VALID, REJECTED

  fileUrl         String?
  rejectionReason String?

  isRequired Boolean @default(true)

  // Yousign Integration
  yousignProcedureId String?
  yousignStatus      String? // started, finished, refused, expired

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("learner_documents")
}

model Training {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  title       String
  code        String? // Reference interne (ex: DEV-001)
  description String?

  durationHours Int   @default(0)
  priceHt       Float @default(0)

  level      String  @default("BEGINNER") // BEGINNER, INTERMEDIATE, ADVANCED, EXPERT
  category   String? // Dev, Langues, Vente...
  programUrl String? // Lien vers PDF

  isActive  Boolean           @default(true)
  examId    String? // Optionnel : lien vers un examen spécifique
  
  // LMS Integration
  externalCourseId String? // Course ID in external LMS (Moodle/360L)
  lmsProvider      String? // 'MOODLE' | '360LEARNING'
  
  folders   LearnerFolder[]
  sessions  TrainingSession[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([organisationId, code])
  @@index([organisationId])
  @@map("trainings")
}

model Lead {
  id             String @id @default(cuid())
  organisationId String

  // Contact Info
  firstName String
  lastName  String
  email     String?
  phone     String

  // Address
  street  String?
  zipCode String?
  city    String?

  // Source & Tracking
  source     String?
  externalId String?
  providerId String?

  // Assignment
  assignedUserId String?

  // Status & Scoring
  status     String  @default("PROSPECT")
  score      Int     @default(50)
  salesStage String?
  jobStatus  String?

  // Dates
  consentDate    DateTime?
  optOut         Boolean   @default(false)
  optOutDate     DateTime?
  responseDate   DateTime?
  nextCallbackAt DateTime?
  lastCallDate   DateTime?

  callAttempts Int     @default(0)
  notes        String?

  // JSON Fields for CRM Extensibility
  closingData Json? // Supported by Prisma SQLite
  metadata    Json? // Supported by Prisma SQLite

  // Relations
  organisation Organisation   @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  provider     ApiProvider?   @relation(fields: [providerId], references: [id])
  examId       String?
  exam         Exam?          @relation(fields: [examId], references: [id])
  agencyId     String?
  agency       Agency?        @relation(fields: [agencyId], references: [id])
  activities   LeadActivity[]
  calls        Call[]
  calendarEvents CalendarEvent[]
  nurturingTasks NurturingTask[]
  nurturingEnrollments NurturingEnrollment[]
  learner      Learner? // This is the reverse relation from Learner.leadId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organisationId])
  @@index([status])
  @@map("leads")
}

// ============================================
// CRM: ACTIVITY & CALL TRACKING
// ============================================

model LeadActivity {
  id     String @id @default(cuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  type     String // NOTE, CALL, EMAIL, STATUS_CHANGE, MEETING, CREATED
  content  String? // Description ou contenu
  metadata String? // JSON pour données additionnelles

  userId String // Qui a fait l'action
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([leadId])
  @@map("lead_activities")
}

model Call {
  id     String @id @default(cuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  duration Int? // Durée en secondes
  outcome  String // ANSWERED, NO_ANSWER, BUSY, VOICEMAIL, WRONG_NUMBER
  notes    String? // Notes de l'appel

  callbackAt DateTime? // Si rappel planifié

  callerId String // Commercial qui a appelé
  caller   User   @relation(fields: [callerId], references: [id])

  recordingUrl String? // URL vers l'enregistrement audio
  
  // AI Analysis Results
  aiAnalysis Json? // { sentiment, objections, summary, keyPoints, analyzedAt }
  
  createdAt    DateTime @default(now())

  @@index([leadId])
  @@index([callerId])
  @@map("calls")
}

model Exam {
  id             String  @id @default(cuid())
  organisationId String
  name           String
  code           String
  description    String?
  isActive       Boolean @default(true)

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  leads        Lead[]
  sessions     ExamSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("exams")
}

model ExamSession {
  id             String   @id @default(cuid())
  examId         String
  exam           Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  agencyId       String?      // Si la session est réservée à une agence spécifique
  agency         Agency?      @relation("AgencySessions", fields: [agencyId], references: [id])
  
  name           String?      // Format: SESSION_AGENCE_DATE
  date           DateTime
  location       String
  minSpots       Int      @default(1)
  totalSpots     Int      @default(10)
  priceHt        Float    @default(0) // Prix par candidat facturé à la franchise
  status         String   @default("WAITING_FOR_REGISTRATION") // WAITING_FOR_REGISTRATION, OPEN, VALIDATION_PENDING, CONFIRMED, COMPLETED, CANCELLED

  registrations  ExamRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("exam_sessions")
}

model ExamRegistration {
  id        String      @id @default(cuid())
  sessionId String
  session   ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  learnerId String
  learner   Learner     @relation(fields: [learnerId], references: [id], onDelete: Cascade)

  status    String      @default("REGISTERED") // REGISTERED, PRESENT, ABSENT, PASSED, FAILED
  score     String?
  notes     String?

  // Additional fields from user screenshots
  motivation     String?
  idNumber       String? // N° de CNI / Passeport
  nativeLanguage String? // Optionnel si différent de l'apprenant
  documentUrl    String? // Link to the proof file

  billingStatus String @default("PENDING") // PENDING, INVOICED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, learnerId])
  @@map("exam_registrations")
}

model Agency {
  id             String  @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  // Franchise (nullable = agence directe OF)
  franchiseId    String?
  franchise      Franchise? @relation(fields: [franchiseId], references: [id])
  
  name           String
  code           String?
  managerName    String?
  
  street         String?
  city           String
  zipCode        String?
  
  phone          String?
  email          String?
  
  isActive       Boolean @default(true)
  isExamCenter   Boolean @default(false)

  // Distribution Configuration
  distributionMode   DistributionMode @default(ROUND_ROBIN)
  distributionConfig Json?

  leads          Lead[]
  learners       Learner[]
  sessions       TrainingSession[]
  examSessions   ExamSession[] @relation("AgencySessions")
  calendarEvents CalendarEvent[]
  users          UserAgency[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("agencies")
}

// ============================================
// FRANCHISE (Franchisés sans NDA propre)
// ============================================

model Franchise {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  // Identité juridique (pas de NDA, utilise celui de l'OF)
  name           String       // Raison sociale
  siret          String?      // SIRET propre
  
  // Contact
  managerName    String?
  email          String?
  phone          String?
  
  // Adresse siège franchise
  street         String?
  city           String?
  zipCode        String?
  
  isActive       Boolean      @default(true)
  
  // Contract Management
  contractStatus    String    @default("PENDING") // PENDING, ACTIVE, EXPIRED, TERMINATED
  contractStartDate DateTime?
  contractEndDate   DateTime?
  signatureDate     DateTime?
  dipSentDate       DateTime?
  
  // Financial Terms
  royaltyRate       Float?    @default(0) // Percentage of turnover
  leadPrice         Float?    @default(0) // Flat price per lead
  
  notes             String?

  // Relations
  agencies       Agency[]     // Agences appartenant à cette franchise
  users          UserFranchise[]  // Utilisateurs de cette franchise
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@map("franchises")
}

// Pivot: User <-> Franchise (un user peut appartenir à plusieurs franchises)
model UserFranchise {
  userId      String
  franchiseId String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  
  @@id([userId, franchiseId])
  @@map("user_franchises")
}

model UserAgency {
  userId   String
  agencyId String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@id([userId, agencyId])
  @@map("user_agencies")
}

model ApiProvider {
  id           String @id @default(cuid())
  name         String
  apiKey       String @unique @default(uuid())
  providerType String @default("LEAD_GENERATOR") // LEAD_GENERATOR, CALL_CENTER, AFFILIATE

  // Compliance & Legal
  legalName        String?
  siret            String?
  complianceStatus String  @default("PENDING") // PENDING, VERIFIED, REJECTED

  // Financial Intelligence
  pricingModel String @default("CPL") // CPL (Cost Per Lead), FIXED (Monthly)
  costPerLead  Float  @default(0)
  currency     String @default("EUR")

  isActive Boolean @default(true)

  // Contact Info (JSON for flexibility)
  contact String? // JSON String: { name, email, phone, role }

  // Relations
  leads Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("api_providers")
}

model IntegrationConfig {
  id             String       @id @default(cuid())
  organisationId String       @unique
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  // Financial Params
  averageCartValue Float @default(1500)
  roiThresholdHigh Float @default(5.0)
  roiThresholdLow  Float @default(1.0)

  // ═══════════════════════════════════════════════════════════
  // WHATSAPP INTEGRATION (Encrypted API Keys)
  // ═══════════════════════════════════════════════════════════
  whatsappProvider       String?  // 'twilio' | 'meta' | null
  
  // Twilio Credentials (AES-256 Encrypted)
  twilioAccountSid       String?  // Encrypted
  twilioAuthToken        String?  // Encrypted
  twilioWhatsappNumber   String?  // Encrypted
  
  // Voice & Recording
  voiceEnabled           Boolean  @default(false)
  recordingEnabled       Boolean  @default(false)
  voiceLastTestedAt      DateTime?
  voiceTestStatus        String?  // 'success' | 'failed' | null

  voiceProvider          String?  // 'TWILIO' | 'AIRCALL' | 'RINGOVER' | 'RINGCENTRAL'
  voiceConfig            Json?    // Provider-specific credentials (encrypted or plain)


  
  // Meta Cloud API Credentials (AES-256 Encrypted)
  metaPhoneNumberId      String?  // Encrypted
  metaAccessToken        String?  // Encrypted
  
  // Status & Audit
  whatsappEnabled        Boolean  @default(false)
  whatsappLastTestedAt   DateTime?
  whatsappTestStatus     String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // SMS INTEGRATION (Twilio)
  // Uses twilioAccountSid & twilioAuthToken from above
  // ═══════════════════════════════════════════════════════════
  smsEnabled             Boolean  @default(false)
  twilioSmsFrom          String?  // Phone Number or Alphanumeric Sender ID
  smsLastTestedAt        DateTime?
  smsTestStatus          String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // GOOGLE CALENDAR INTEGRATION (OAuth 2.0)
  // ═══════════════════════════════════════════════════════════
  googleCalendarEnabled     Boolean  @default(false)
  googleAccessToken         String?  // Encrypted
  googleRefreshToken        String?  // Encrypted
  googleTokenExpiry         DateTime?
  googleCalendarId          String?  // Selected calendar ID
  googleConnectedEmail      String?  // User who connected
  googleLastSyncAt          DateTime?
  googleSyncStatus          String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // YOUSIGN INTEGRATION (Electronic Signature)
  // ═══════════════════════════════════════════════════════════
  yousignEnabled         Boolean  @default(false)
  yousignApiKey          String?  // Encrypted
  yousignEnvironment     String?  // 'sandbox' | 'production'
  yousignLastTestedAt    DateTime?
  yousignTestStatus      String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // STRIPE PAYMENT INTEGRATION
  // ═══════════════════════════════════════════════════════════
  stripeEnabled          Boolean  @default(false)
  stripeSecretKey        String?  // Encrypted
  stripePublishableKey   String?
  stripeWebhookSecret    String?  // Encrypted
  stripeLastTestedAt     DateTime?
  stripeTestStatus       String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // EMAIL PROVIDER INTEGRATION (SendGrid / Brevo)
  // ═══════════════════════════════════════════════════════════
  emailEnabled           Boolean  @default(false)
  emailProvider          String?  // 'SENDGRID' | 'BREVO' | 'RESEND'
  emailApiKey            String?  // Encrypted
  emailFromAddress       String?
  emailFromName          String?
  emailLastTestedAt      DateTime?
  emailTestStatus        String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // AI PROVIDER INTEGRATION (Gemini / OpenAI)
  // ═══════════════════════════════════════════════════════════
  aiEnabled              Boolean  @default(false)
  aiProvider             String?  // 'GEMINI' | 'OPENAI'
  aiApiKey               String?  // Encrypted
  aiModel                String?  // e.g., 'gemini-1.5-flash', 'gpt-4o-mini'
  aiLastTestedAt         DateTime?
  aiTestStatus           String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // WEBHOOKS INTEGRATION (Inbound)
  // ═══════════════════════════════════════════════════════════
  webhookSecret          String?  // Secret token for /api/webhooks/leads validation

  // ═══════════════════════════════════════════════════════════
  // LMS INTEGRATION (Moodle / 360Learning)
  // ═══════════════════════════════════════════════════════════
  lmsEnabled             Boolean  @default(false)
  lmsProvider            String?  // 'MOODLE' | '360LEARNING'
  lmsApiUrl              String?  // e.g., https://moodle.example.com
  lmsApiKey              String?  // Encrypted (Moodle token or 360L API Key)
  lmsApiSecret           String?  // Encrypted (360L Secret only)
  lmsLastTestedAt        DateTime?
  lmsTestStatus          String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // EDOF / MonCompteFormation (CPF)
  // ═══════════════════════════════════════════════════════════
  edofEnabled            Boolean  @default(false)
  edofApiKey             String?  // Encrypted - API Key from CDC
  edofNda                String?  // Numéro de Déclaration d'Activité
  edofSiret              String?  // SIRET of the organization
  edofLastSyncAt         DateTime?
  edofTestStatus         String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // CHORUS PRO (Public Invoicing)
  // ═══════════════════════════════════════════════════════════
  chorusEnabled          Boolean  @default(false)
  chorusClientId         String?  // OAuth Client ID
  chorusClientSecret     String?  // Encrypted - OAuth Client Secret
  chorusAccountLogin     String?  // cpro-account login (base64 encoded)
  chorusAccountPassword  String?  // Encrypted
  chorusEnvironment      String?  // 'sandbox' | 'production'
  chorusLastTestedAt     DateTime?
  chorusTestStatus       String?  // 'success' | 'failed' | null

  // ═══════════════════════════════════════════════════════════
  // KAIROS (France Travail / Pôle Emploi)
  // ═══════════════════════════════════════════════════════════
  kairosEnabled          Boolean  @default(false)
  kairosApiKey           String?  // Encrypted
  kairosOrganismId       String?  // Identifiant organisme
  kairosLastSyncAt       DateTime?
  kairosTestStatus       String?  // 'success' | 'failed' | null

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("integration_configs")
}



model AgencyMapping {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  externalAgencyId String // ID sent by the API provider (e.g. "123", "AG-PARIS")
  internalAgencyId String // UUID of the local Agency

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organisationId, externalAgencyId]) // external ID must be unique within an org
  @@map("agency_mappings")
}

model TrainingSession {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  trainingId String?
  training   Training? @relation(fields: [trainingId], references: [id])

  formateurId   String? // Link to Formateur
  formateur     Formateur? @relation(fields: [formateurId], references: [id])
  formateurName String?

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  date      DateTime
  startTime String? // ex: "09:00"
  endTime   String? // ex: "12:00"
  title     String?
  location  String?  @default("Distanciel")

  status String @default("OPEN") // OPEN, CLOSED

  attendanceLogs AttendanceLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("training_sessions")
}

model AttendanceLog {
  id       String        @id @default(cuid())
  folderId String
  folder   LearnerFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)

  sessionId String?
  session   TrainingSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  date      DateTime
  duration  Int // Durée en minutes ou heures (à définir, restons sur Int pour l'instant)
  signature String // Base64 string of the signature
  status    String   @default("SIGNED") // SIGNED, ABSENT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("attendance_logs")
}

// ============================================
// VEILLE & ÉCOSYSTÈME (Indicateurs 23-26)
// ============================================

model WatchArticle {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  // Content
  title       String
  url         String?
  source      String?  // Ex: "Legifrance", "Centre Inffo", "LinkedIn"
  category    String   // LEGAL, METIERS, PEDAGOGIE, HANDICAP
  indicator   String?  // I23, I24, I25, I26
  
  // User Input
  readAt      DateTime?
  readBy      String?  // User ID who marked as read
  notes       String?  // Personal notes

  // AI Analysis (Gemini)
  aiSummary       String?
  aiImpact        String?  // What this means for the OF
  aiRecommendations String? // Suggested actions

  // Lifecycle
  status      String   @default("UNREAD") // UNREAD, READ, ANALYZED, ACTIONED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  actions  ImpactAction[]

  @@map("watch_articles")
}

model ImpactAction {
  id        String   @id @default(cuid())
  articleId String
  article   WatchArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  title       String
  description String?
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  status      String   @default("TODO") // TODO, IN_PROGRESS, DONE
  dueDate     DateTime?
  completedAt DateTime?
  assignedTo  String?  // User ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("impact_actions")
}

model EcosystemPartner {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  name        String
  type        String   // AGEFIPH, CAP_EMPLOI, OPCO, CFA, EXPERT, OTHER
  domain      String?  // Handicap, Emploi, Financement, etc.
  
  contactName  String?
  contactEmail String?
  contactPhone String?
  website      String?
  
  // Billing Info for OPCOs
  siret       String?
  street      String?
  zipCode     String?
  city        String?

  conventionUrl  String?  // Document de convention
  conventionDate DateTime?
  
  notes       String?
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ecosystem_partners")
}

// ============================================
// AUDIT & CONTRÔLE (Intelligence Shield)
// ============================================

model AuditReport {
  id             String       @id @default(cuid())
  organisationId String
  folderId       String?      // Optional: can be org-wide or folder-specific
  
  // Report Metadata
  type        String   // FOLDER, BATCH, ORGANISATION
  title       String
  status      String   @default("PENDING") // PENDING, PASSED, FAILED, CRITICAL
  
  // Compliance Scores
  overallScore     Int?     // 0-100
  contractScore    Int?     // Triptyque: Contrat
  attendanceScore  Int?     // Triptyque: Émargement
  invoiceScore     Int?     // Triptyque: Facture

  // AI Analysis
  aiFindings       String?  // JSON: list of findings
  aiRecommendations String?
  riskLevel        String?  // LOW, MEDIUM, HIGH, CRITICAL

  // Integrity
  integrityHash    String?  // SHA-256 hash of the report
  hashGeneratedAt  DateTime?
  proofArchiveUrl  String?  // URL to ZIP of proof documents

  generatedAt DateTime @default(now())
  generatedBy String?  // User who triggered the audit

  alerts ComplianceAlert[]

  @@map("audit_reports")
}

model ComplianceAlert {
  id        String   @id @default(cuid())
  reportId  String?
  report    AuditReport? @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  organisationId String
  folderId       String?
  
  // Alert Details
  type        String   // SIGNATURE_ANOMALY, HOUR_MISMATCH, MISSING_DOC, FRAUD_SUSPICION
  severity    String   // INFO, WARNING, ERROR, CRITICAL
  title       String
  description String?
  
  // Evidence
  evidenceData String?  // JSON: relevant data points
  
  // Resolution
  status      String   @default("OPEN") // OPEN, INVESTIGATING, RESOLVED, DISMISSED
  resolvedAt  DateTime?
  resolvedBy  String?
  resolution  String?

  createdAt DateTime @default(now())

  @@map("compliance_alerts")
}

model AuditLog {
  id             String   @id @default(cuid())
  organisationId String
  
  // What changed
  entityType  String   // LEARNER_FOLDER, DOCUMENT, ATTENDANCE, etc.
  entityId    String
  action      String   // CREATE, UPDATE, DELETE, VIEW
  field       String?  // Which field was changed
  oldValue    String?
  newValue    String?
  
  // Who/When
  userId      String?
  userName    String?
  ipAddress   String?
  userAgent   String?
  
  timestamp   DateTime @default(now())

  @@map("audit_logs")
}

// ============================================
// BILAN PÉDAGOGIQUE ET FINANCIER (BPF)
// ============================================

model BPFReport {
  id             String       @id @default(cuid())
  organisationId String
  year           Int          // Reporting year (e.g., 2025)
  
  status         String       @default("DRAFT") // DRAFT, VALIDATED, SUBMITTED
  
  // CADRE C (Financial)
  totalRevenue     Float      @default(0)
  cpfRevenue       Float      @default(0)
  opcoRevenue      Float      @default(0)
  poleEmploiRevenue Float     @default(0)
  companyRevenue   Float      @default(0)
  individualRevenue Float     @default(0)
  publicRevenue    Float      @default(0) // State/Regions
  otherRevenue     Float      @default(0)
  
  // CADRE E (Trainees)
  totalTrainees    Int        @default(0)
  cpfTrainees      Int        @default(0)
  opcoTrainees     Int        @default(0)
  otherTrainees    Int        @default(0)
  
  // CADRE F (Training Hours)
  totalHours       Float      @default(0)
  cpfHours         Float      @default(0)
  opcoHours        Float      @default(0)
  otherHours       Float      @default(0)

  // CADRE G (Staff)
  internalTrainers Int        @default(0)
  externalTrainers Int        @default(0)
  
  // AI Analysis (Gemini)
  aiSynthesis      String?    // Executive summary generated by AI
  aiConsistency    String?    // JSON: Consistency check results
  riskLevel        String?    // LOW, MEDIUM, HIGH
  
  // Meta
  submissionDate   DateTime?
  integrityHash    String?    // SHA-256 of the validated report
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  alerts    BPFAlert[]

  @@unique([organisationId, year])
  @@map("bpf_reports")
}

model BPFAlert {
  id        String    @id @default(cuid())
  reportId  String
  report    BPFReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@map("bpf_alerts")
}

// ============================================
// FINANCES & FACTURATION (Smart Ledger)
// ============================================

model Invoice {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id]) // The OF issuing the invoice
  
  // Client (Payer)
  payerType      String       // LEARNER, COMPANY, OPCO, CPF, POLE_EMPLOI
  payerName      String
  payerAddress   String?
  payerSiret     String?      // If company/OPCO
  
  // Relations
  folderId       String?
  folder         LearnerFolder? @relation(fields: [folderId], references: [id])
  
  // B2B Portal
  clientCompanyId String?
  clientCompany   ClientCompany? @relation(fields: [clientCompanyId], references: [id])
  
  // Invoice Core
  number         String       // e.g., INV-2026-0001
  
  // Chorus Pro (Public Sector)
  chorusEngagement   String?  // Numéro d'engagement (engagementNumber)
  chorusServiceCode  String?  // Code service Chorus
  
  date           DateTime     @default(now())
  dueDate        DateTime
  status         String       @default("DRAFT") // DRAFT, SENT, PARTIAL, PAID, OVERDUE, CANCELLED
  type           String       @default("INVOICE") // INVOICE, CREDIT_NOTE (Avoir)

  // Financials
  subTotal       Float
  taxAmount      Float        @default(0) // Often 0 for OF (exonération)
  totalAmount    Float
  balanceDue     Float        // Amount remaining to be paid
  
  // Meta
  publicNote     String?      // Visible on PDF
  privateNote    String?      // Internal use
  pdfUrl         String?      // Link to generated PDF
  sentAt         DateTime?

  // Stripe
  stripePaymentLinkId String?
  stripePaymentUrl    String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  lines          InvoiceLine[]
  payments       Payment[]

  @@unique([organisationId, number]) // Unique invoice number per OF
  @@map("invoices")
}

model InvoiceLine {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Float
  unitPrice   Float
  taxRate     Float    @default(0)
  total       Float

  @@map("invoice_lines")
}

model Payment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  
  amount      Float
  date        DateTime @default(now())
  method      String   // TRANSFER, CARD, CHECK, DIRECT_DEBIT, CPF_AUTO
  reference   String?  // Transaction ID
  
  notes       String?
  status      String   @default("COMPLETED") // PENDING, COMPLETED, FAILED

  createdAt   DateTime @default(now())
  
  @@map("invoices_payments")
}

// ============================================
// PORTAIL ENTREPRISE (B2B Client)
// ============================================

model ClientCompany {
  id             String       @id @default(cuid())
  organisationId String       // The OF this company is a client of
  organisation   Organisation @relation(fields: [organisationId], references: [id])
  
  name           String
  siret          String?
  address        String?
  website        String?
  logo           String?

  // Primary Contact
  contactName    String?
  contactEmail   String?
  contactPhone   String?

  // Access
  isActive       Boolean      @default(true)
  portalCode     String?      // Simple code for quick invite

  // Relations
  users          User[]       // HR Managers / Admins for this company
  learners       Learner[]    // Employees
  invoices       Invoice[]    // Bills

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("client_companies")
}

// ============================================
// REPORTING STRATÉGIQUE (Cockpit V3)
// ============================================

model StrategicReport {
  id             String       @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id])
  
  period         String       // e.g., "2026-Q1", "2026-03"
  type           String       @default("MONTHLY") // MONTHLY, QUARTERLY, ON_DEMAND

  // 1. Predictive Finance
  currentPipelineValue Float    @default(0) // Valeur pondérée des leads
  projectedRevenue     Float    @default(0) // CA estimé à M+3
  confidenceScore      Int      @default(0) // 0-100% fiabilité de la prédiction

  // 2. Risk Audit (Snapshot)
  riskScore            Int      @default(0) // 0-100 (100 = High Risk)
  
  // 3. AI Analysis
  executiveSummary     String?  // Synthèse pour le CODIR
  strategicRecommendations String? // Actions recommandées
  marketBenchmark      String?  // Comparaison sectorielle (JSON)

  createdAt      DateTime     @default(now())
  
  risks          RiskIndicator[]
  evidence       EvidenceMetric[]

  @@map("strategic_reports")
}

model RiskIndicator {
  id             String          @id @default(cuid())
  reportId       String
  report         StrategicReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  type           String // REVENUE_GAP, ATTENDANCE_DROP, TEAM_CHURN, COMPLIANCE_ALERT
  severity       String // LOW, MEDIUM, HIGH, CRITICAL
  
  label          String
  currentValue   String // "85%"
  targetValue    String // "95%"
  trend          String // UP, DOWN, STABLE
  
  description    String?

  @@map("risk_indicators")
}

model EvidenceMetric {
  id             String          @id @default(cuid())
  reportId       String
  report         StrategicReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  category       String // SUCCESS_RATE, SATISFACTION, INSERTION, REVENUE_GROWTH
  label          String
  value          Float  // e.g., 92.5
  unit           String // PERCENT, EUR, COUNT
  
  source         String? // "Pôle Emploi", "Interne", "Questionnaire"
  validationDate DateTime?
  
  proofUrl       String? // Link to generated PDF proof

  @@map("evidence_metrics")
}

// ═══════════════════════════════════════════════════════════════════════════════
// WALLET & CREDITS SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model Wallet {
  id              String    @id @default(cuid())
  organisationId  String    @unique
  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  balance         Float     @default(0.0) // Wallet balance in currency units (e.g. EUR)
  currency        String    @default("EUR")
  
  transactions    WalletTransaction[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("wallets")
}

model WalletTransaction {
  id              String    @id @default(cuid())
  walletId        String
  wallet          Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  amount          Float     // Positive for deposit, negative for usage
  type            String    // 'DEPOSIT', 'USAGE', 'REFUND', 'BONUS'
  reference       String?   // "SMS to +33...", "Stripe Charge #..."
  metadata        Json?     // Extra details
  
  createdAt       DateTime  @default(now())

  @@map("wallet_transactions")
}
enum DistributionMode {
  ROUND_ROBIN
  LOAD_BALANCED
  SKILL_BASED
}// ============================================
// NURTURING & AUTOMATION
// ============================================

model NurturingSequence {
  id             String @id @default(cuid())
  organisationId String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  name           String
  description    String?
  isActive       Boolean @default(true)
  
  steps          NurturingStep[]
  enrollments    NurturingEnrollment[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("nurturing_sequences")
}

model NurturingStep {
  id             String @id @default(cuid())
  sequenceId     String
  sequence       NurturingSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  
  order          Int
  type           String // SMS, EMAIL
  channel        String @default("WHATSAPP") // WHATSAPP, SMS, EMAIL
  
  delayInHours   Int @default(0) // Delay from previous step or enrollment start
  
  subject        String? // For email
  content        String // Template content (Variant A)
  contentB       String? // Variant B (Optional)
  
  tasks          NurturingTask[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("nurturing_steps")
}

model NurturingEnrollment {
  id             String @id @default(cuid())
  leadId         String
  lead           Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  sequenceId     String
  sequence       NurturingSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  
  status         String @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  
  tasks          NurturingTask[]
  
  enrolledAt     DateTime @default(now())
  completedAt    DateTime?
  cancelledAt    DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([leadId, sequenceId, status])
  @@map("nurturing_enrollments")
}

model NurturingTask {
  id             String   @id @default(cuid())
  leadId         String
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  organisationId String
  
  enrollmentId   String?
  enrollment     NurturingEnrollment? @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)
  
  stepId         String?
  step           NurturingStep? @relation(fields: [stepId], references: [id], onDelete: SetNull)

  type           String   @default("SMS") // SMS, EMAIL
  channel        String   @default("WHATSAPP") // WHATSAPP, SMS, EMAIL
  
  scheduledAt    DateTime
  executedAt     DateTime?
  status         String   @default("PENDING") // PENDING, EXECUTED, CANCELLED, FAILED
  
  content        String
  variant        String? @default("A") // 'A' or 'B'
  metadata       Json?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([leadId])
  @@index([status, scheduledAt])
  @@map("nurturing_tasks")
}

// ============================================
// GAMIFICATION SYSTEM
// ============================================

model Achievement {
  id          String   @id @default(cuid())
  slug        String   @unique // ex: "first_deal", "100_calls"
  name        String
  description String?
  icon        String?  // Lucide icon name or emoji
  points      Int      @default(0)
  
  // Logic
  category    String   // CALLS, DEALS, STREAK, QUALITY
  threshold   Int      // Value to reach (e.g. 100)
  
  userAchievements UserAchievement[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  
  unlockedAt    DateTime @default(now())
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Challenge {
  id             String   @id @default(cuid())
  organisationId String
  
  title       String
  description String?
  type        String   // INDIVIDUAL, TEAM
  metric      String   // CALLS_COUNT, DEALS_VALUE, APPOINTMENTS
  target      Float
  
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  
  participants ChallengeParticipant[]
  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("challenges")
}

model ChallengeParticipant {
  id          String   @id @default(cuid())
  challengeId String
  userId      String
  
  score       Float    @default(0)
  rank        Int?
  
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([challengeId, userId])
  @@map("challenge_participants")
}

// ============================================
// DASHBOARD PERSONALIZATION
// ============================================

model DashboardConfig {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String @default("Mon Dashboard")
  isDefault Boolean @default(false)
  
  // JSON array of widget configurations
  widgets   String // JSON stringified: [{ id, type, title, metric, icon, color, size }]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("dashboard_configs")
}
